# Extending Version Files

Nagare 1.8.0+ provides multiple ways to extend generated version files with your own custom exports, without needing to
write a full custom template.

## Overview

When generating version files, nagare provides standard exports like `VERSION`, `BUILD_INFO`, `APP_INFO`, etc. However,
many projects need additional exports specific to their application. Nagare offers three approaches:

1. **Additional Exports** - Simple configuration for common export types
2. **Extend with Prepend/Append** - Add raw content before/after the generated file
3. **Custom Templates** - Full control with Vento templates (for advanced use cases)

## Additional Exports

The `additionalExports` configuration allows you to add constants, classes, functions, and other exports to your version
file.

### Basic Example

```typescript
// nagare.config.ts
export default {
  versionFile: {
    path: "./version.ts",
    template: TemplateFormat.TYPESCRIPT,
    additionalExports: [
      {
        name: "API_CONFIG",
        type: "const",
        value: { url: "https://api.example.com", timeout: 5000 },
        description: "API configuration",
        asConst: true,
      },
    ],
  },
  // ... rest of config
};
```

This generates:

```typescript
// version.ts (generated)
export const VERSION = "1.0.0";
// ... standard exports ...

// Additional exports configured in nagare.config.ts

/** API configuration */
export const API_CONFIG = {
  "url": "https://api.example.com",
  "timeout": 5000,
} as const;
```

### Supported Export Types

#### Constants (`const`, `let`, `var`)

```typescript
{
  name: "CONFIG",
  type: "const",
  value: { feature: "enabled", maxUsers: 100 },
  description: "Application configuration",
  asConst: true,  // Adds "as const" for TypeScript
}
```

#### Classes

```typescript
{
  name: "VersionUtils",
  type: "class",
  description: "Utility methods for version info",
  content: `
  static getFullVersion(): string {
    return \`\${VERSION} (Build: \${BUILD_INFO.gitCommit})\`;
  }
  
  static getMajorVersion(): number {
    return BUILD_INFO.versionComponents.major;
  }`,
}
```

#### Functions

```typescript
{
  name: "formatVersion",
  type: "function",
  description: "Format version with prefix",
  content: `(prefix: string = "v"): string {
    return \`\${prefix}\${VERSION}\`;
  }`,
}

// Async functions
{
  name: "checkVersion",
  type: "function",
  async: true,
  content: `(): Promise<boolean> {
    const response = await fetch("/api/version");
    const data = await response.json();
    return data.version === VERSION;
  }`,
}
```

#### TypeScript Types and Interfaces

```typescript
{
  name: "VersionInfo",
  type: "interface",
  content: `{
    version: string;
    major: number;
    minor: number;
    patch: number;
    prerelease?: string;
  }`,
}

{
  name: "VersionString",
  type: "type",
  content: "`v${number}.${number}.${number}`",
}
```

#### Enums

```typescript
{
  name: "ReleaseStage",
  type: "enum",
  content: `
    Development = "development",
    Staging = "staging",
    Production = "production",
  `,
}
```

## Extend with Prepend/Append

For simple additions like comments, imports, or footer content, use the `extend` option:

```typescript
versionFile: {
  path: "./version.ts",
  template: TemplateFormat.TYPESCRIPT,
  extend: {
    prepend: `// This file is auto-generated by nagare
// Do not edit manually
// Last generated: ${new Date().toISOString()}

`,
    append: `
// Custom footer
export const BUILD_TIMESTAMP = ${Date.now()};
`,
  },
}
```

## Real-World Example: Salty Project

Here's how the Salty encryption project uses these features:

```typescript
// nagare.config.ts
import type { NagareConfig } from "@rick/nagare/types";
import { TemplateFormat } from "@rick/nagare/types";

export default {
  project: {
    name: "Salty",
    description: "Browser-Native Secure Text Encryption",
    repository: "https://github.com/esolia/salty.esolia.pro",
  },

  versionFile: {
    path: "./version.ts",
    template: TemplateFormat.TYPESCRIPT,

    additionalExports: [
      // Application-specific constants
      {
        name: "TECH_SPECS",
        type: "const",
        value: {
          platform: "Deno Deploy",
          runtime: "Deno",
          cryptoFeatures: [
            "AES-GCM-256 encryption",
            "PBKDF2-SHA512 key derivation",
            "600,000 iterations",
            "basE91 encoding",
            "Web Crypto API",
          ],
        },
        asConst: true,
      },

      // Security configuration
      {
        name: "SECURITY_INFO",
        type: "const",
        value: {
          rateLimiting: { window: "1 hour", maxRequests: 20 },
          maxPayloadSize: "1MB",
          securityHeaders: [
            "Content-Security-Policy",
            "Strict-Transport-Security",
          ],
        },
        asConst: true,
      },

      // Utility class
      {
        name: "VersionUtils",
        type: "class",
        content: `
  static getExtendedVersion(): string {
    return \`\${VERSION} (Built: \${BUILD_INFO.buildDate})\`;
  }
  
  static isPrerelease(): boolean {
    return BUILD_INFO.versionComponents.prerelease !== null;
  }`,
      },
    ],
  },
} satisfies NagareConfig;
```

## Migration from Custom Templates

If you're currently using a full custom template just to add a few exports, you can simplify your configuration:

**Before (Custom Template):**

```typescript
versionFile: {
  template: TemplateFormat.CUSTOM,
  customTemplate: `// ... entire template with all standard exports plus custom ones ...`,
}
```

**After (Additional Exports):**

```typescript
versionFile: {
  template: TemplateFormat.TYPESCRIPT,  // Use built-in template
  additionalExports: [
    // Just define your custom exports
  ],
}
```

## Best Practices

1. **Use descriptive names** - Export names should clearly indicate their purpose
2. **Add descriptions** - Use the `description` field for JSDoc comments
3. **Type safety** - Use `asConst` for configuration objects in TypeScript
4. **Avoid conflicts** - Don't use names that conflict with nagare's built-in exports
5. **Keep it simple** - For complex logic, consider keeping it in separate modules

## Limitations

- Additional exports are not supported for JSON/YAML templates (these formats don't support JavaScript exports)
- Export names must be valid JavaScript identifiers
- The feature is designed for common use cases; very complex scenarios may still require custom templates

## Upgrading

To use these features, ensure you're using nagare 1.8.0 or later:

```bash
deno add @rick/nagare@^1.8.0
```

Then update your `nagare.config.ts` to use the new `additionalExports` or `extend` options instead of custom templates
where appropriate.

# How to configure Nagare

This guide shows you how to configure Nagare for different use cases. Use these approaches when you need to customize version management, file updates, or release workflows.

## Before you begin

Ensure you have:
- Nagare initialized in your project (`deno task nagare init`).
- A `nagare.config.ts` file in your project root.
- Understanding of basic TypeScript/JavaScript.

## Solution

### Option 1: basic configuration

Use this approach for simple projects with standard requirements.

1. Set up minimal configuration with project metadata:
   ```typescript
   import type { NagareConfig } from "jsr:@rick/nagare/types";

   export default {
     project: {
       name: "My Project",
       repository: "https://github.com/user/repo",
     },
     versionFile: {
       path: "./version.ts",
       template: "typescript",
     },
   } as NagareConfig;
   ```

2. Add GitHub integration for automatic releases:
   ```typescript
   github: {
     owner: "user",
     repo: "repo",
     createRelease: true,
   }
   ```

### Option 2: advanced file updates

Use this approach when you need to update multiple files during releases.

1. Configure automatic file updates using built-in handlers:
   ```typescript
   updateFiles: [
     // Built-in handlers detect file type automatically
     { path: "./deno.json" },
     { path: "./package.json" },
     { path: "./README.md" },
     { path: "./jsr.json" },
     { path: "./Cargo.toml" },
   ]
   ```

2. Add custom file updates for special cases:
   ```typescript
   updateFiles: [
     // Custom pattern for specific file
     {
       path: "./config/app.yaml",
       patterns: {
         version: /^version:\s*"([^"]+)"/m,
       },
     },
     
     // Custom update function for complex logic
     {
       path: "./src/constants.ts",
       updateFn: (content, data) => {
         return content.replace(
           /APP_VERSION = "[^"]+"/,
           `APP_VERSION = "${data.version}"`
         );
       },
     },
   ]
   ```

### Option 3: custom version file templates

Use this approach when the built-in templates don't meet your needs.

1. Use a built-in template format:
   ```typescript
   versionFile: {
     path: "./version.ts",
     template: "typescript", // or "json", "yaml"
   }
   ```

2. Create a custom template using Vento syntax:
   ```typescript
   versionFile: {
     path: "./version.ts",
     template: "custom",
     customTemplate: `
   // Generated by Nagare on {{ buildDate |> safe }}
   export const VERSION = "{{ version |> safe }}";
   export const BUILD_DATE = "{{ buildDateFormatted |> safe }}";
   export const GIT_COMMIT = "{{ gitCommit |> safe }}";
   export const FEATURES = {{ metadata.features |> jsonStringify |> safe }};
   `
   }
   ```

3. Extend existing templates with additional exports:
   ```typescript
   versionFile: {
     path: "./version.ts",
     template: "typescript",
     additionalExports: [
       {
         name: "CONFIG",
         type: "const",
         value: { apiUrl: "https://api.example.com" },
         asConst: true,
       },
       {
         name: "getVersionInfo",
         type: "function",
         content: `
   (): string {
     return \`\${VERSION} (built on \${BUILD_INFO.buildDate})\`;
   }`
       },
     ],
   }
   ```

### Option 4: commit type customization

Use this approach to customize how commits affect version bumps.

```typescript
commitTypes: {
  // Custom commit types
  "perf": "patch",      // Performance improvements
  "deps": "patch",      // Dependency updates
  "security": "patch",  // Security fixes
  
  // Override defaults
  "docs": null,         // Don't trigger releases for docs
  "style": null,        // Don't trigger releases for style changes
}
```

### Option 5: release notes configuration

Use this to customize changelog generation.

```typescript
releaseNotes: {
  includeCommitHashes: true,
  maxDescriptionLength: 100,
  
  // Group commits by type
  sections: {
    "feat": "Added",
    "fix": "Fixed",
    "perf": "Performance",
    "security": "Security",
    "deps": "Dependencies",
  },
  
  // Custom release note template
  template: `
## [{{ version }}] - {{ date }}

{{ #if added }}
### Added
{{ #each added }}
- {{ this }}
{{ /each }}
{{ /if }}

{{ #if fixed }}
### Fixed
{{ #each fixed }}
- {{ this }}
{{ /each }}
{{ /if }}
`
}
```

### Option 6: lifecycle hooks

Use hooks to run custom code during the release process.

```typescript
hooks: {
  // Run before version bump
  preRelease: [
    async () => {
      console.log("Running tests...");
      const { success } = await new Deno.Command("deno", {
        args: ["test"],
      }).output();
      
      if (!success) {
        throw new Error("Tests failed");
      }
    },
  ],
  
  // Run after release completes
  postRelease: [
    async () => {
      console.log("Notifying team...");
      // Send notification to Slack, Discord, etc.
    },
  ],
}
```

### Option 7: documentation generation

Configure automatic API documentation generation.

```typescript
docs: {
  enabled: true,
  outputDir: "./docs/api",
  includePrivate: false,
  
  // Custom doc generation command
  command: ["deno", "doc", "--html", "--name=MyProject"],
}
```

### Option 8: security configuration

Configure security settings for template processing.

```typescript
security: {
  templateSandbox: "strict",    // strict | moderate | disabled
  validateFilePaths: true,
  auditLog: true,
  maxTemplateSize: 1048576,     // 1MB limit
}
```

## Verify your configuration

Test your configuration before using it:

```bash
# Validate configuration
deno task nagare --dry-run

# Check specific bump type
deno task nagare:minor --dry-run

# View parsed configuration
deno run -A nagare-launcher.ts --version-detailed
```

## Troubleshooting

**Problem**: "Configuration file not found"
**Solution**: Ensure `nagare.config.ts` exists in your project root or specify path with `--config`.

**Problem**: "Invalid configuration"
**Solution**: Check TypeScript types match `NagareConfig` interface.

**Problem**: "File update pattern not matching"
**Solution**: Use built-in handlers or test regex patterns with line anchors (`^` and `$`).

## Related tasks

- [How to use hooks](./how-to-use-hooks.md)
- [How to customize templates](./how-to-customize-templates.md)
- [How to rollback releases](./how-to-rollback.md)
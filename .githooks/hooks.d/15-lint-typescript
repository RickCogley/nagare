#!/bin/sh
# 15-lint-typescript - Run Deno linter on staged TypeScript files

set -e

echo "  üìù Running linter..."

# Get staged TypeScript files, excluding test files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ts$' | grep -v '_test\.ts$' | grep -v '\.test\.ts$' | grep -v '^tests/' || true)

if [ -z "$STAGED_TS_FILES" ]; then
  exit 0
fi

# Run linter and capture output (exclude test files from strict linting)
LINT_OUTPUT=$(deno lint $STAGED_TS_FILES 2>&1 || true)

# Check for errors
if echo "$LINT_OUTPUT" | grep -q "error\["; then
  echo "     ‚ùå Linting errors found:"
  echo "$LINT_OUTPUT" | grep "error\[" | head -5 | sed 's/^/        /'
  echo "     Fix linting errors before committing"
  exit 1
fi

# Check for warnings
if echo "$LINT_OUTPUT" | grep -q "warn\["; then
  echo "     ‚ö†Ô∏è  Linting warnings found:"
  echo "$LINT_OUTPUT" | grep "warn\[" | head -3 | sed 's/^/        /'
fi

echo "     ‚úÖ Linting passed"
exit 0